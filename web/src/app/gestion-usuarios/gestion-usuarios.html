<div class="admin-layout">
  <app-notificaciones #notificaciones></app-notificaciones>
  <app-sidebar></app-sidebar>
  <div class="main-content">
    <h2 class="titulo-pagina-usuarios">Gestión de Usuarios</h2>
    <div class="crear-usuario-container">
      <button class="crear-usuario-btn" (click)="abrirModalCrearUsuario()">
        <span class="icono-crear-usuario">
          <!-- Icono Plus Circle -->
          <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <circle cx="12" cy="12" r="9" stroke-width="1.5"/>
            <path stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M12 8v8m4-4H8"/>
          </svg>
        </span>
        Crear usuario
      </button>
    </div>

    <!-- Filtros para la tabla de usuarios -->
    <div class="filtros-usuarios-outer">
      <div class="filtros-usuarios-barra">
        <input type="text" class="input-filtro-usuarios" [(ngModel)]="filtroEmail" placeholder="Email">
        <select class="input-filtro-usuarios" [(ngModel)]="filtroRol">
          <option value="">Rol</option>
          <option *ngFor="let rol of roles" [value]="rol.value">{{ rol.label }}</option>
        </select>
        <select class="input-filtro-usuarios" [(ngModel)]="filtroEstado">
          <option value="">Estado</option>
          <option value="activo">Activo</option>
          <option value="inactivo">Inactivo</option>
        </select>
        <button type="button" class="btn-usuarios-lupa" (click)="aplicarFiltros()" title="Filtrar">
          <!-- SVG lupa -->
          <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <circle cx="11" cy="11" r="7" stroke-width="2"/>
            <line x1="16.5" y1="16.5" x2="21" y2="21" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <button type="button" class="btn-usuarios-reiniciar" (click)="reiniciarFiltros()" title="Reiniciar filtros">
          <!-- SVG reinicio -->
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path d="M4 4v5h5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 20v-5h-5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5.07 19A9 9 0 1 1 12 21a9 9 0 0 1-6.93-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="tabla-container">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th (click)="ordenarPor('username')">
              Username
              <span class="icono-orden"
                    [ngClass]="{
                      'activo-asc': ordenCampo === 'username' && ordenAsc,
                      'activo-desc': ordenCampo === 'username' && !ordenAsc
                    }">
                <svg class="arriba" viewBox="0 0 14 8"><path d="M2 6L7 2L12 6"/></svg>
                <svg class="abajo" viewBox="0 0 14 8"><path d="M2 2L7 6L12 2"/></svg>
              </span>
            </th>
            <th (click)="ordenarPor('first_name')">
              Nombre
              <span class="icono-orden"
                    [ngClass]="{
                      'activo-asc': ordenCampo === 'first_name' && ordenAsc,
                      'activo-desc': ordenCampo === 'first_name' && !ordenAsc
                    }">
                <svg class="arriba" viewBox="0 0 14 8"><path d="M2 6L7 2L12 6"/></svg>
                <svg class="abajo" viewBox="0 0 14 8"><path d="M2 2L7 6L12 2"/></svg>
              </span>
            </th>
            <th (click)="ordenarPor('last_name')">
              Apellido
              <span class="icono-orden"
                    [ngClass]="{
                      'activo-asc': ordenCampo === 'last_name' && ordenAsc,
                      'activo-desc': ordenCampo === 'last_name' && !ordenAsc
                    }">
                <svg class="arriba" viewBox="0 0 14 8"><path d="M2 6L7 2L12 6"/></svg>
                <svg class="abajo" viewBox="0 0 14 8"><path d="M2 2L7 6L12 2"/></svg>
              </span>
            </th>
            <th>Correo Electrónico</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Fecha de alta</th>
            <th>Último acceso</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Mostrar usuarios dinámicamente -->
          <tr *ngFor="let usuario of usuarios">
            <td class="textos-largos">{{ usuario.username }}</td>
            <td class="textos-largos">{{ usuario.first_name ? usuario.first_name : 'Anonimo' }}</td> <!-- Si no encuentra first_name se muestra 'Anonimo' -->
            <td class="textos-largos">{{ usuario.last_name ? usuario.last_name : 'Anonimo' }}</td> <!-- Si no encuentra last_name se muestra 'Anonimo' -->
            <td class="textos-largos">{{ usuario.email }}</td>
            <td>{{ usuario.rol | titlecase }}</td>
            <td>
              <span class="badge-estado" [ngClass]="usuario.is_active ? 'estado-activo' : 'estado-inactivo'">
                {{ usuario.is_active ? 'Activo' : 'Inactivo' }}
              </span>
            </td>
            <td>
              {{ usuario.date_joined ? (usuario.date_joined | date:'yyyy-MM-dd') : '-' }}
            </td>
            <td>
              {{ usuario.last_login ? (usuario.last_login | date:'yyyy-MM-dd HH:mm') : '-' }}
            </td>
            <td>
              <!-- Tus botones de acción aquí, igual que antes -->
              <button class="icon-btn" title="Editar" (click)="abrirModalEditarUsuario(usuario)">
                <!-- Icono lápiz -->
                <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                </svg>
              </button>
              <button class="icon-btn" [title]="usuario.is_active ? 'Dar de baja' : 'Activar'" (click)="abrirModalEstadoUsuario(usuario)">
                <!-- Icono según estado -->
                <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <circle cx="12" cy="7" r="4" stroke-width="1.7"/>
                  <path stroke-width="1.7" stroke-linecap="round" d="M5 21c0-3.5 3.5-6 7-6s7 2.5 7 6"/>
                  <path *ngIf="usuario.is_active" stroke-width="1.7" stroke-linecap="round" d="M9 12l2 2 4-4"/>
                </svg>
              </button>
              <button class="icon-btn" title="Eliminar" (click)="abrirModalEliminarUsuario(usuario)">
                <!-- Icono papelera -->
                <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <rect x="5" y="7" width="14" height="12" rx="2" stroke-width="1.7"/>
                  <path stroke-width="1.7" stroke-linecap="round" d="M9 11v4M15 11v4M3 7h18M10 3h4a1 1 0 0 1 1 1v3H9V4a1 1 0 0 1 1-1z"/>
                </svg>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Solo mostrar paginación si hay usuarios (registros vaya)-->
    <div class="paginacion-usuarios-centro" *ngIf="usuarios.length > 0">
      <app-paginacion-gestion
        [paginaActual]="paginaActual"
        [totalPaginas]="totalPaginas"
        [pageSize]="pageSize"
        [opcionesPageSize]="opcionesPageSize"
        (paginaCambiada)="onPaginaCambiada($event)"
        (pageSizeCambiado)="onPageSizeCambiado($event)">
      </app-paginacion-gestion>
    </div>
  </div>
</div>

<!-- Modal de Edición/Creación de Usuario -->
<div class="modal-backdrop" *ngIf="modalUsuarioAbierto" (click)="cerrarModalUsuario()"></div>
<div class="modal-editar" *ngIf="modalUsuarioAbierto">
  <div class="modal-header">
    <h3>{{ modoCreacionUsuario ? 'Crear Usuario' : 'Editar Usuario' }}</h3>
    <button class="cerrar-modal" (click)="cerrarModalUsuario()">×</button>
  </div>
  <div class="modal-body">
    <form [formGroup]="formularioUsuario" (ngSubmit)="guardarUsuario()">
      <!-- Solo mostrar estos campos al crear usuario -->
      <div *ngIf="modoCreacionUsuario">
        <div class="form-group">
          <label for="first_name">Nombre:</label>
          <input id="first_name" type="text" formControlName="first_name" class="form-input" (input)="actualizarErroresUsuario()">
          <div class="container-espacio-mensaje" *ngIf="getErroresCampo('nombre').length > 0">
            <app-mensajes
              *ngFor="let msg of getErroresCampo('nombre')"
              [tipo]="'error-form'"
              [mensaje]="msg">
            </app-mensajes>
          </div>
        </div>
        <div class="form-group">
          <label for="last_name">Apellido:</label>
          <input id="last_name" type="text" formControlName="last_name" class="form-input" (input)="actualizarErroresUsuario()">
          <div class="container-espacio-mensaje" *ngIf="getErroresCampo('apellido').length > 0">
            <app-mensajes
              *ngFor="let msg of getErroresCampo('apellido')"
              [tipo]="'error-form'"
              [mensaje]="msg">
            </app-mensajes>
          </div>
        </div>
        <div class="form-group">
          <label for="username">Username:</label>
          <input id="username" type="text" formControlName="username" class="form-input" required (input)="actualizarErroresUsuario()">
          <div class="container-espacio-mensaje" *ngIf="getErroresCampo('usuario').length > 0">
            <app-mensajes
              *ngFor="let msg of getErroresCampo('usuario')"
              [tipo]="'error-form'"
              [mensaje]="msg">
            </app-mensajes>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="email">Email:</label>
        <input id="email" type="email" formControlName="email" class="form-input" (input)="actualizarErroresUsuario()">
        <div class="container-espacio-mensaje">
          <app-mensajes
            *ngIf="formularioUsuario.get('email')?.errors?.['formatoEmail'] && formularioUsuario.get('email')?.touched"
            [tipo]="'error-form'"
            [mensaje]="formularioUsuario.get('email')?.errors?.['formatoEmail']">
          </app-mensajes>
          <ng-container *ngFor="let msg of getErroresCampo('email')">
            <app-mensajes
              *ngIf="!(formularioUsuario.get('email')?.errors?.['formatoEmail'] && msg.includes('formato válido'))"
              [tipo]="'error-form'"
              [mensaje]="msg">
            </app-mensajes>
          </ng-container>
        </div>
      </div>
      <div class="form-group">
        <label for="rol">Rol:</label>
        <select id="rol" formControlName="rol" class="form-input">
          <option *ngFor="let rol of roles" [value]="rol.value">{{ rol.label }}</option>
        </select>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancelar" (click)="cerrarModalUsuario()">Cancelar</button>
      <button type="submit" class="btn-guardar">
        {{ modoCreacionUsuario ? 'Crear' : 'Guardar' }}
      </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Confirmación de Eliminación de Usuario -->
<div class="modal-backdrop" *ngIf="modalEliminarUsuarioAbierto" (click)="cerrarModalEliminarUsuario()"></div>
<div class="modal-confirmar" *ngIf="modalEliminarUsuarioAbierto">
  <div class="modal-header">
    <h3>Confirmar Eliminación</h3>
    <button class="cerrar-modal" (click)="cerrarModalEliminarUsuario()">×</button>
  </div>
  <div class="modal-body">
    <p class="mensaje-eliminar">
      ¿Estás seguro de que deseas eliminar el usuario <strong>{{ usuarioActual?.username }}</strong>?
    </p>
    <p class="advertencia-eliminar">Esta acción no se puede deshacer.</p>
  </div>
  <div class="modal-footer footer-eliminar">
    <div class="botones-confirmacion">
      <button type="button" class="btn-cancelar" (click)="cerrarModalEliminarUsuario()">Cancelar</button>
      <button type="button" class="btn-eliminar" (click)="eliminarUsuario()">Eliminar</button>
    </div>
  </div>
</div>

<!-- Modal de Confirmación de Estado de Usuario -->
<div class="modal-backdrop" *ngIf="modalEstadoUsuarioAbierto" (click)="cerrarModalEstadoUsuario()"></div>
<div class="modal-confirmar modal-confirmar-estado" *ngIf="modalEstadoUsuarioAbierto">
  <div class="modal-header">
    <h3>{{ usuarioEstadoActual?.is_active ? 'Dar de baja' : 'Activar' }} usuario</h3>
    <button class="cerrar-modal" (click)="cerrarModalEstadoUsuario()">×</button>
  </div>
  <div class="modal-body">
    <p>
      ¿Seguro que quieres 
      <strong>{{ usuarioEstadoActual?.is_active ? 'dar de baja' : 'activar' }}</strong>
      al usuario <strong>{{ usuarioEstadoActual?.username }}</strong>?
    </p>
  </div>
  <div class="modal-footer footer-eliminar">
    <button type="button" class="btn-cancelar" (click)="cerrarModalEstadoUsuario()">Cancelar</button>
    <button type="button" class="btn-guardar" (click)="confirmarCambioEstadoUsuario()">
      {{ usuarioEstadoActual?.is_active ? 'Dar de baja' : 'Activar' }}
    </button>
  </div>
</div>